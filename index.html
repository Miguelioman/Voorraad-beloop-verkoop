<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Voorraad & Verkoop Dashboard + ABC%</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Excel reader -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b1220;
      color: #0f172a;
    }
    header {
      background: linear-gradient(90deg, #0b3954, #1f6feb);
      color: #e5efff;
      padding: 16px 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    header h1 { margin: 0; font-size: 20px; font-weight: 650; }
    header p { margin: 6px 0 0; font-size: 13px; opacity: .92; }

    .container {
      max-width: 1400px;
      margin: 16px auto 40px;
      padding: 18px 18px 30px;
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 14px 30px rgba(15,23,42,.25);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 16px;
      align-items: flex-end;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      margin: 12px 0 12px;
    }

    label {
      font-size: 13px;
      color: #0f172a;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    input[type="file"], select, input[type="number"] {
      font-size: 13px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #f9fafb;
      min-width: 220px;
      outline: none;
    }
    input[type="number"] { min-width: 150px; }
    input[type="file"]:focus, select:focus, input[type="number"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,.25);
      background: #fff;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      background: #f8fafc;
      font-size: 13px;
      color: #0f172a;
    }

    .status {
      font-size: 12px;
      color: #475569;
      margin-left: 6px;
    }

    .section {
      margin-top: 18px;
      padding-top: 10px;
      border-top: 1px solid #e5e7eb;
    }
    .section h2 {
      margin: 0 0 6px;
      font-size: 15px;
      color: #0b3954;
    }
    .section p {
      margin: 0 0 10px;
      font-size: 12px;
      color: #475569;
      line-height: 1.4;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 1050px) {
      .grid.two {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 8px 16px rgba(15,23,42,.08);
      overflow: hidden;
    }

    .card-header {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(90deg, #0b3954, #1f4f9a);
      color: #e5efff;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      justify-content: space-between;
    }
    .card-header .title {
      font-size: 13px;
      font-weight: 650;
      margin: 0;
    }
    .card-header .actions {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      font-size: 12px;
    }
    .card-body { padding: 10px 12px 12px; }

    /* Grotere grafieken */
    .canvas-wrap {
      width: 100%;
      overflow-x: auto;
      padding: 6px 2px 2px;
    }
    .chart-box {
      min-width: 920px;
      height: 520px;
    }
    .chart-box.tall {
      height: 600px;
    }
    @media (max-width: 980px) {
      .chart-box { min-width: 860px; }
    }
    @media (max-width: 720px) {
      .chart-box { min-width: 760px; height: 520px; }
      .chart-box.tall { height: 560px; }
    }
    canvas { width: 100% !important; height: 100% !important; }

    .checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      background: #f8fafc;
    }
    .checkboxes .group-title {
      font-size: 12px;
      font-weight: 650;
      color: #0b3954;
      margin-right: 8px;
    }
    .cb {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-size: 12px;
      color: #0f172a;
      user-select: none;
    }
    .cb input { margin: 0; }

    .btn {
      border: 1px solid #cbd5f5;
      background: #ffffff;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .btn:hover { background: #f1f5f9; }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 900px;
    }
    thead {
      background: #0b3954;
      color: #e5efff;
    }
    th, td {
      padding: 7px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) { background: #f9fafb; }
    tbody tr:hover { background: #e0ecff; }

    .note {
      font-size: 11px;
      color: #64748b;
      margin-top: 8px;
      line-height: 1.4;
    }

    .hidden { display: none; }
  </style>
</head>

<body>
  <header>
    <h1>Voorraad & Verkoop Dashboard + ABC% per maand</h1>
    <p>Upload Excel (maand-sheets). Toggle productcategorieën; dashboards & ABC% passen zich direct aan op alleen de aangevinkte selectie.</p>
  </header>

  <div class="container">
    <div class="controls">
      <label>
        Excel-bestand (.xlsx / .xls)
        <input type="file" id="excelFileInput" accept=".xlsx,.xls" />
      </label>

      <span class="pill">
        <strong>Maanden:</strong> <span id="monthsInfo" class="status">—</span>
      </span>

      <span id="statusMessage" class="status"></span>
    </div>

    <div id="categoryControls" class="checkboxes hidden">
      <span class="group-title">Categoriën zichtbaar:</span>
      <button class="btn" id="btnAllOn" type="button">Alles aan</button>
      <button class="btn" id="btnAllOff" type="button">Alles uit</button>
      <span class="status" id="catHint"></span>
      <div id="categoryCheckboxList" style="display:flex; flex-wrap:wrap; gap:8px 10px; margin-left: 8px;"></div>
    </div>

    <div class="section">
      <h2>1) Voorraadverloop per maand (Ending inventory units)</h2>
      <p>Lijngrafiek met totale eindvoorraad per maand per productcategorie. Optioneel trendlines aan/uit. Inclusief tabel met exacte waarden.</p>

      <div class="card">
        <div class="card-header">
          <div class="title">Voorraad over tijd per categorie</div>
          <div class="actions">
            <label class="cb" style="background:transparent; border:0; color:#e5efff;">
              <input type="checkbox" id="toggleTrendlines" />
              Trendlines tonen
            </label>
          </div>
        </div>
        <div class="card-body">
          <div class="canvas-wrap">
            <div class="chart-box tall">
              <canvas id="inventoryLineChart"></canvas>
            </div>
          </div>
          <div class="note">Voorraad = som van <strong>Ending inventory units</strong> per sheet/maand per categorie (alleen aangevinkt).</div>
        </div>
      </div>

      <div class="card" style="margin-top: 12px;">
        <div class="card-header">
          <div class="title">Tabel: eindvoorraad per maand per categorie</div>
        </div>
        <div class="card-body">
          <div class="table-wrap">
            <table id="inventoryTable"><thead></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>2) Verkopen per maand per categorie (Inventory units sold)</h2>
      <p>Gestapelde staafdiagram van totaal verkochte units per maand, uitgesplitst per productcategorie. Inclusief tabel met waarden.</p>

      <div class="card">
        <div class="card-header">
          <div class="title">Verkopen per maand per categorie</div>
        </div>
        <div class="card-body">
          <div class="canvas-wrap">
            <div class="chart-box">
              <canvas id="salesBarChart"></canvas>
            </div>
          </div>
          <div class="note">Verkopen = som van <strong>Inventory units sold</strong> per maand per categorie (alleen aangevinkt).</div>
        </div>
      </div>

      <div class="card" style="margin-top: 12px;">
        <div class="card-header">
          <div class="title">Tabel: verkopen per maand per categorie</div>
        </div>
        <div class="card-body">
          <div class="table-wrap">
            <table id="salesTable"><thead></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>3) Omzet (bruto / netto)</h2>
      <p>
        Staafdiagram van totale omzet per productcategorie. Kies <strong>bruto</strong> (units × verkoopprijs)
        of <strong>netto</strong> (bruto − units × inkoopprijs). Inkoopprijzen zijn instelbaar.
      </p>

      <div class="controls" style="margin-top: 4px;">
        <label>
          Weergave
          <select id="revenueModeSelect">
            <option value="gross" selected>Bruto omzet</option>
            <option value="net">Netto omzet (bruto - inkoop)</option>
          </select>
        </label>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="title">Omzet per categorie (totaal)</div>
        </div>
        <div class="card-body">
          <div class="canvas-wrap">
            <div class="chart-box">
              <canvas id="revenueBarChart"></canvas>
            </div>
          </div>
          <div class="note">Grafiek is gebaseerd op alleen aangevinkte categorieën.</div>
        </div>
      </div>

      <div class="card" style="margin-top: 12px;">
        <div class="card-header">
          <div class="title">Omzet per maand per categorie (bruto / netto)</div>
        </div>
        <div class="card-body">
          <div class="canvas-wrap">
            <div class="chart-box">
              <canvas id="revenueMonthBarChart"></canvas>
            </div>
          </div>
          <div class="note">Gestapeld; volgt dezelfde keuze (bruto/netto) als hierboven.</div>
        </div>
      </div>

      <div class="grid two" style="margin-top: 12px;">
        <div class="card">
          <div class="card-header">
            <div class="title">Instelbare inkoopprijzen (€) per categorie</div>
          </div>
          <div class="card-body" id="costInputsWrap"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="title">Tabel: totale omzet per categorie</div>
          </div>
          <div class="card-body">
            <div class="table-wrap">
              <table id="revenueTable"><thead></thead><tbody></tbody></table>
            </div>
            <div class="note">Tabel toont bruto én netto; grafiek volgt selectie (bruto/netto).</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 12px;">
        <div class="card-header">
          <div class="title">Tabel: omzet per categorie per maand als % van totale omzet per maand</div>
        </div>
        <div class="card-body">
          <div class="table-wrap">
            <table id="revenueShareTable"><thead></thead><tbody></tbody></table>
          </div>
          <div class="note">Percentage is op basis van <strong>bruto</strong> omzet en alleen aangevinkte categorieën.</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>4) ABC-analyse: percentage A / B / C producten per maand</h2>
      <p>
        Per maand wordt een ABC-analyse uitgevoerd op <strong>SKU-niveau</strong> op basis van omzet.
        De analyse gebruikt <strong>alleen de aangevinkte categorieën</strong>. SKU’s met
        <strong>Starting inventory units = 0</strong> worden die maand <strong>uitgesloten</strong>.
      </p>

      <div class="card">
        <div class="card-header">
          <div class="title">ABC% per maand (100% gestapeld)</div>
        </div>
        <div class="card-body">
          <div class="canvas-wrap">
            <div class="chart-box">
              <canvas id="abcPctChart"></canvas>
            </div>
          </div>
          <div class="note">
            Percentages zijn gebaseerd op het aantal SKU’s dat die maand in de ABC-analyse zit (na filters en uitsluiting startvoorraad=0).
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 12px;">
        <div class="card-header">
          <div class="title">Tabel: % A / % B / % C per maand</div>
        </div>
        <div class="card-body">
          <div class="table-wrap">
            <table id="abcPctTable"><thead></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------- Helpers --------
    function canonicalizeProductType(raw) {
      if (raw == null) return null;
      const str = String(raw).trim();
      if (!str) return null;
      const t = str.toLowerCase();
      if (t === 'nan') return null;

      if (t.includes('compressiesok')) return 'compressiesokken';
      if (t.includes('sneaker')) return 'sneakers';
      if (t.includes('klomp') || t.includes('schoen')) return 'klompen';
      if (t.includes('mok')) return 'mokken';
      if (t.includes('sok')) return 'sokken';
      return str;
    }

    // Verkoopprijzen (zoals jij vroeg)
    function getSellPrice(cat) {
      if (!cat) return 0;
      const t = String(cat).toLowerCase();
      if (t.includes('compressiesok')) return 29.99;
      if (t.includes('sneaker')) return 99.99;
      if (t.includes('klomp')) return 79.99;
      if (t.includes('mok')) return 14.95;
      if (t.includes('sok')) return 11.95;
      return 0;
    }

    // Default inkoopprijzen
    const defaultCosts = {
      'sokken': 2.00,
      'compressiesokken': 2.00,
      'mokken': 2.50,
      'klompen': 18.00,
      'sneakers': 18.00
    };

    function parseMonthLabel(label) {
      if (!label) return null;
      const str = String(label);
      const parts = str.split(/[-\\/]/);
      if (parts.length === 2) {
        const m = parseInt(parts[0], 10);
        const y = parseInt(parts[1], 10);
        if (!isNaN(m) && !isNaN(y)) return new Date(y, m - 1, 1);
      }
      const d = new Date(str);
      if (!isNaN(d.getTime())) return d;
      return null;
    }

    function euro(n) {
      const v = (n == null || !isFinite(n)) ? 0 : Number(n);
      return v.toLocaleString('nl-NL', { style: 'currency', currency: 'EUR' });
    }
    function num(n, decimals=0) {
      const v = (n == null || !isFinite(n)) ? 0 : Number(n);
      return v.toLocaleString('nl-NL', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }
    function pct(n) {
      const v = (n == null || !isFinite(n)) ? 0 : Number(n);
      return v.toLocaleString('nl-NL', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%';
    }

    function linearRegression(yValues) {
      const n = yValues.length;
      if (n < 2) return null;
      let sumX=0,sumY=0,sumXY=0,sumXX=0;
      for (let i=0;i<n;i++){
        const x=i;
        const y=Number(yValues[i])||0;
        sumX+=x; sumY+=y; sumXY+=x*y; sumXX+=x*x;
      }
      const denom = (n*sumXX - sumX*sumX);
      if (denom === 0) return null;
      const slope = (n*sumXY - sumX*sumY)/denom;
      const intercept = (sumY - slope*sumX)/n;
      const fitted=[];
      for (let i=0;i<n;i++) fitted.push(intercept + slope*i);
      return fitted;
    }

    // Chart defaults
    Chart.defaults.font.size = 13;
    Chart.defaults.plugins.legend.labels.boxWidth = 14;
    Chart.defaults.plugins.legend.labels.padding = 12;

    function axisTickFont() { return { size: 13, weight: '600' }; }
    function axisTitleFont() { return { size: 14, weight: '700' }; }

    // -------- State --------
    const state = {
      months: [],        // [{label,date, rows[]}]
      monthLabels: [],
      categories: [],
      selectedCats: new Set(),
      costs: {},
      inventory: {},     // month -> {cat: sum endingInv}
      sales: {},         // month -> {cat: sum sold}
      revenueGross: {},  // month -> {cat: gross}
      revenueNet: {},    // month -> {cat: net}
      abcPct: {},        // month -> {A,B,C,total, pctA,pctB,pctC}
      charts: {
        inventory: null,
        sales: null,
        revenue: null,
        revenueMonth: null,
        abcPct: null
      }
    };

    // -------- DOM --------
    const excelFileInput = document.getElementById('excelFileInput');
    const statusMessage = document.getElementById('statusMessage');
    const monthsInfo = document.getElementById('monthsInfo');

    const categoryControls = document.getElementById('categoryControls');
    const categoryCheckboxList = document.getElementById('categoryCheckboxList');
    const btnAllOn = document.getElementById('btnAllOn');
    const btnAllOff = document.getElementById('btnAllOff');
    const catHint = document.getElementById('catHint');

    const toggleTrendlines = document.getElementById('toggleTrendlines');
    const revenueModeSelect = document.getElementById('revenueModeSelect');
    const costInputsWrap = document.getElementById('costInputsWrap');

    const inventoryTable = document.getElementById('inventoryTable');
    const salesTable = document.getElementById('salesTable');
    const revenueTable = document.getElementById('revenueTable');
    const revenueShareTable = document.getElementById('revenueShareTable');

    const abcPctTable = document.getElementById('abcPctTable');

    function setStatus(msg){ statusMessage.textContent = msg || ''; }

    function destroyCharts() {
      for (const k of Object.keys(state.charts)) {
        if (state.charts[k]) { state.charts[k].destroy(); state.charts[k] = null; }
      }
    }

    function initCosts() {
      const costs = {};
      state.categories.forEach(cat => {
        const key = String(cat).toLowerCase();
        costs[cat] = (defaultCosts[key] != null) ? defaultCosts[key] : 0;
      });
      state.costs = costs;
    }

    function buildCategoryControls() {
      categoryCheckboxList.innerHTML = '';
      state.selectedCats = new Set(state.categories); // default aan

      state.categories.forEach(cat => {
        const wrap = document.createElement('label');
        wrap.className = 'cb';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = true;

        const span = document.createElement('span');
        span.textContent = cat;

        cb.addEventListener('change', () => {
          if (cb.checked) state.selectedCats.add(cat);
          else state.selectedCats.delete(cat);
          recomputeAllWithSelection();
          renderAll();
        });

        wrap.appendChild(cb);
        wrap.appendChild(span);
        categoryCheckboxList.appendChild(wrap);
      });

      btnAllOn.onclick = () => {
        state.selectedCats = new Set(state.categories);
        [...categoryCheckboxList.querySelectorAll('input[type="checkbox"]')].forEach(c => c.checked = true);
        recomputeAllWithSelection();
        renderAll();
      };

      btnAllOff.onclick = () => {
        state.selectedCats = new Set();
        [...categoryCheckboxList.querySelectorAll('input[type="checkbox"]')].forEach(c => c.checked = false);
        recomputeAllWithSelection();
        renderAll();
      };

      catHint.textContent = ' (toggle beïnvloedt alle grafieken & tabellen incl. ABC%)';
      categoryControls.classList.remove('hidden');
    }

    function buildCostInputs() {
      costInputsWrap.innerHTML = '';
      const box = document.createElement('div');
      box.className = 'row';

      state.categories.forEach(cat => {
        const lab = document.createElement('label');
        lab.style.minWidth = '240px';
        lab.textContent = `${cat} (inkoopprijs)`;

        const inp = document.createElement('input');
        inp.type = 'number';
        inp.step = '0.01';
        inp.value = (state.costs[cat] != null ? state.costs[cat] : 0);

        inp.addEventListener('input', () => {
          const v = parseFloat(inp.value);
          state.costs[cat] = isFinite(v) ? v : 0;
          recomputeRevenueNetForSelection();
          renderRevenue();
        });

        lab.appendChild(inp);
        box.appendChild(lab);
      });

      costInputsWrap.appendChild(box);

      const note = document.createElement('div');
      note.className = 'note';
      note.textContent = 'Netto omzet = (units × verkoopprijs) − (units × inkoopprijs).';
      costInputsWrap.appendChild(note);
    }

    function visibleCats() {
      return state.categories.filter(c => state.selectedCats.has(c));
    }

    // -------- Extract workbook (store raw month rows incl SKU) --------
    function extractWorkbook(workbook) {
      const months = [];

      workbook.SheetNames.forEach(name => {
        const sheet = workbook.Sheets[name];
        if (!sheet) return;

        const json = XLSX.utils.sheet_to_json(sheet, { defval: null });
        const rows = [];

        json.forEach(row => {
          const productType = canonicalizeProductType(row['Product type']);
          if (!productType) return;

          const skuRaw = row['Product variant SKU'];
          const sku = skuRaw != null ? String(skuRaw).trim() : '';
          if (!sku) return;

          let startingInv = Number(row['Starting inventory units']);
          if (!isFinite(startingInv)) startingInv = 0;

          let endingInv = Number(row['Ending inventory units']);
          if (!isFinite(endingInv)) endingInv = 0;

          let unitsSold = Number(row['Inventory units sold']);
          if (!isFinite(unitsSold)) unitsSold = 0;

          rows.push({
            productType,
            sku,
            startingInv,
            endingInv,
            unitsSold
          });
        });

        months.push({
          label: name,
          date: parseMonthLabel(name),
          rows
        });
      });

      months.sort((a,b) => {
        if (a.date && b.date) return a.date - b.date;
        if (a.date && !b.date) return -1;
        if (!a.date && b.date) return 1;
        return a.label.localeCompare(b.label, 'nl-NL');
      });

      state.months = months;
      state.monthLabels = months.map(m => m.label);
      monthsInfo.textContent = state.monthLabels.length ? state.monthLabels.join(', ') : '—';

      const catSet = new Set();
      months.forEach(m => m.rows.forEach(r => catSet.add(r.productType)));
      state.categories = Array.from(catSet).sort((a,b) => a.localeCompare(b, 'nl-NL'));

      initCosts();
      buildCategoryControls();
      buildCostInputs();

      // compute aggregates based on initial selection (all)
      recomputeAllWithSelection();
    }

    // -------- Recompute all aggregates based on selected categories --------
    function recomputeAllWithSelection() {
      const cats = new Set(visibleCats());

      // init structures
      const inventory = {};
      const sales = {};
      const revenueGross = {};

      state.monthLabels.forEach(m => {
        inventory[m] = {};
        sales[m] = {};
        revenueGross[m] = {};
        state.categories.forEach(cat => {
          // keep keys for all categories; charts/tables use visibleCats()
          inventory[m][cat] = 0;
          sales[m][cat] = 0;
          revenueGross[m][cat] = 0;
        });
      });

      // aggregate (only selected cats)
      state.months.forEach(month => {
        const ml = month.label;
        month.rows.forEach(r => {
          if (!cats.has(r.productType)) return;

          inventory[ml][r.productType] += r.endingInv;
          sales[ml][r.productType] += r.unitsSold;
          revenueGross[ml][r.productType] += r.unitsSold * getSellPrice(r.productType);
        });
      });

      state.inventory = inventory;
      state.sales = sales;
      state.revenueGross = revenueGross;

      recomputeRevenueNetForSelection();
      recomputeAbcPctForSelection();
    }

    function recomputeRevenueNetForSelection() {
      const cats = new Set(visibleCats());
      const revenueNet = {};

      state.monthLabels.forEach(m => {
        revenueNet[m] = {};
        state.categories.forEach(cat => {
          if (!cats.has(cat)) {
            revenueNet[m][cat] = 0;
            return;
          }
          const units = state.sales[m][cat] || 0;
          const gross = state.revenueGross[m][cat] || 0;
          const cost = state.costs[cat] != null ? state.costs[cat] : 0;
          revenueNet[m][cat] = gross - (units * cost);
        });
      });

      state.revenueNet = revenueNet;
    }

    // -------- ABC% per month based on selected categories (SKU-level) --------
    function recomputeAbcPctForSelection() {
      const cats = new Set(visibleCats());
      const abcPct = {};

      state.months.forEach(month => {
        // SKU revenue aggregation within selected categories
        const skuAgg = new Map(); // sku -> {revenue, startingInvMax}
        month.rows.forEach(r => {
          if (!cats.has(r.productType)) return;

          let agg = skuAgg.get(r.sku);
          if (!agg) {
            agg = { revenue: 0, startingInv: 0 };
            skuAgg.set(r.sku, agg);
          }
          if (r.startingInv > agg.startingInv) agg.startingInv = r.startingInv;
          agg.revenue += r.unitsSold * getSellPrice(r.productType);
        });

        // candidates = startingInv > 0  (EXCLUDE startingInv == 0)
        const candidates = [];
        skuAgg.forEach((v, sku) => {
          if (v.startingInv > 0) candidates.push({ sku, revenue: v.revenue });
        });

        if (candidates.length === 0) {
          abcPct[month.label] = { A:0, B:0, C:0, total:0, pctA:0, pctB:0, pctC:0 };
          return;
        }

        const totalRevenue = candidates.reduce((s, x) => s + x.revenue, 0);
        candidates.sort((a,b) => b.revenue - a.revenue);

        let cumulative = 0;
        let countA = 0, countB = 0, countC = 0;

        if (totalRevenue <= 0) {
          countC = candidates.length;
        } else {
          for (const c of candidates) {
            cumulative += c.revenue;
            const share = cumulative / totalRevenue;

            if (share <= 0.80) countA++;
            else if (share <= 0.95) countB++;
            else countC++;
          }
        }

        const total = candidates.length;
        abcPct[month.label] = {
          A: countA,
          B: countB,
          C: countC,
          total,
          pctA: total > 0 ? (countA / total) * 100 : 0,
          pctB: total > 0 ? (countB / total) * 100 : 0,
          pctC: total > 0 ? (countC / total) * 100 : 0
        };
      });

      state.abcPct = abcPct;
    }

    // -------- Rendering: Inventory --------
    function buildLineDatasetsForInventory(showTrend) {
      const cats = visibleCats();
      const labels = state.monthLabels;
      const datasets = [];

      cats.forEach(cat => {
        const data = labels.map(m => state.inventory[m][cat] || 0);
        datasets.push({
          label: cat,
          data,
          tension: 0.2,
          borderWidth: 3,
          pointRadius: 2
        });

        if (showTrend) {
          const fitted = linearRegression(data);
          if (fitted) {
            datasets.push({
              label: `${cat} (trend)`,
              data: fitted,
              tension: 0,
              borderWidth: 3,
              borderDash: [7, 6],
              pointRadius: 0
            });
          }
        }
      });

      return datasets;
    }

    function renderInventory() {
      const ctx = document.getElementById('inventoryLineChart');
      const showTrend = !!toggleTrendlines.checked;

      if (state.charts.inventory) state.charts.inventory.destroy();

      state.charts.inventory = new Chart(ctx, {
        type: 'line',
        data: { labels: state.monthLabels, datasets: buildLineDatasetsForInventory(showTrend) },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 18, right: 16, top: 10, bottom: 6 } },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${num(c.parsed.y, 0)}` } }
          },
          scales: {
            y: {
              title: { display: true, text: 'Eindvoorraad (units)', font: axisTitleFont() },
              ticks: { font: axisTickFont(), padding: 10, callback: (v) => num(v, 0) }
            },
            x: {
              title: { display: true, text: 'Maand', font: axisTitleFont() },
              ticks: { font: axisTickFont(), padding: 6 }
            }
          }
        }
      });

      const cats = visibleCats();
      const thead = inventoryTable.querySelector('thead');
      const tbody = inventoryTable.querySelector('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';

      const hr = document.createElement('tr');
      const th0 = document.createElement('th'); th0.textContent = 'Maand'; hr.appendChild(th0);
      cats.forEach(cat => { const th=document.createElement('th'); th.textContent=cat; hr.appendChild(th); });
      thead.appendChild(hr);

      state.monthLabels.forEach(m => {
        const tr = document.createElement('tr');
        const tdM = document.createElement('td'); tdM.textContent=m; tr.appendChild(tdM);
        cats.forEach(cat => {
          const td=document.createElement('td');
          td.textContent = num(state.inventory[m][cat] || 0, 0);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // -------- Rendering: Sales --------
    function renderSales() {
      const ctx = document.getElementById('salesBarChart');
      if (state.charts.sales) state.charts.sales.destroy();

      const cats = visibleCats();
      const labels = state.monthLabels;

      const datasets = cats.map(cat => ({
        label: cat,
        data: labels.map(m => state.sales[m][cat] || 0)
      }));

      state.charts.sales = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 18, right: 16, top: 10, bottom: 6 } },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${num(c.parsed.y, 0)}` } }
          },
          scales: {
            x: { stacked: true, title: { display: true, text: 'Maand', font: axisTitleFont() }, ticks: { font: axisTickFont(), padding: 6 } },
            y: { stacked: true, title: { display: true, text: 'Verkochte units', font: axisTitleFont() }, ticks: { font: axisTickFont(), padding: 10, callback: (v) => num(v, 0) } }
          }
        }
      });

      const thead = salesTable.querySelector('thead');
      const tbody = salesTable.querySelector('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';

      const hr = document.createElement('tr');
      const th0 = document.createElement('th'); th0.textContent = 'Maand'; hr.appendChild(th0);
      cats.forEach(cat => { const th=document.createElement('th'); th.textContent=cat; hr.appendChild(th); });
      thead.appendChild(hr);

      labels.forEach(m => {
        const tr = document.createElement('tr');
        const tdM = document.createElement('td'); tdM.textContent=m; tr.appendChild(tdM);
        cats.forEach(cat => {
          const td=document.createElement('td');
          td.textContent = num(state.sales[m][cat] || 0, 0);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // -------- Rendering: Revenue --------
    function totalByCategory(mapMonthCat, catsList) {
      const totals = {};
      catsList.forEach(cat => totals[cat] = 0);
      state.monthLabels.forEach(m => {
        catsList.forEach(cat => totals[cat] += (mapMonthCat[m][cat] || 0));
      });
      return totals;
    }

    function renderRevenue() {
      const mode = revenueModeSelect.value; // gross | net
      const monthCat = (mode === 'net') ? state.revenueNet : state.revenueGross;

      const cats = visibleCats();
      const totals = totalByCategory(monthCat, cats);

      // total revenue by cat
      const ctx = document.getElementById('revenueBarChart');
      if (state.charts.revenue) state.charts.revenue.destroy();

      state.charts.revenue = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: cats,
          datasets: [{
            label: mode === 'net' ? 'Netto omzet' : 'Bruto omzet',
            data: cats.map(cat => totals[cat] || 0)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 18, right: 16, top: 10, bottom: 6 } },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${euro(c.parsed.y)}` } }
          },
          scales: {
            y: { title: { display: true, text: 'Omzet (€)', font: axisTitleFont() }, ticks: { font: axisTickFont(), padding: 10, callback: (v) => euro(v) } },
            x: { title: { display: true, text: 'Productcategorie', font: axisTitleFont() }, ticks: { font: axisTickFont(), padding: 6 } }
          }
        }
      });

      // revenue per month stacked
      const ctxM = document.getElementById('revenueMonthBarChart');
      if (state.charts.revenueMonth) state.charts.revenueMonth.destroy();

      const labels = state.monthLabels;
      const datasetsMonth = cats.map(cat => ({
        label: cat,
        data: labels.map(m => monthCat[m][cat] || 0)
      }));

      state.charts.revenueMonth = new Chart(ctxM, {
        type: 'bar',
        data: { labels, datasets: datasetsMonth },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 18, right: 16, top: 10, bottom: 6 } },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${euro(c.parsed.y)}` } }
          },
          scales: {
            x: { stacked: true, title: { display: true, text: 'Maand', font: axisTitleFont() }, ticks: { font: axisTickFont(), padding: 6 } },
            y: { stacked: true, title: { display: true, text: 'Omzet (€)', font: axisTitleFont() }, ticks: { font: axisTickFont(), padding: 10, callback: (v) => euro(v) } }
          }
        }
      });

      // revenue totals table (gross + net) for visible cats
      const revHead = revenueTable.querySelector('thead');
      const revBody = revenueTable.querySelector('tbody');
      revHead.innerHTML = ''; revBody.innerHTML = '';

      const trH = document.createElement('tr');
      ['Categorie', 'Verkoopprijs', 'Inkoopprijs', 'Bruto omzet', 'Netto omzet'].forEach(h => {
        const th = document.createElement('th'); th.textContent = h; trH.appendChild(th);
      });
      revHead.appendChild(trH);

      const totalsGross = totalByCategory(state.revenueGross, cats);
      const totalsNet = totalByCategory(state.revenueNet, cats);

      cats.forEach(cat => {
        const tr = document.createElement('tr');
        const tdC = document.createElement('td'); tdC.textContent = cat; tr.appendChild(tdC);
        const tdP = document.createElement('td'); tdP.textContent = euro(getSellPrice(cat)); tr.appendChild(tdP);
        const tdCost = document.createElement('td'); tdCost.textContent = euro(state.costs[cat] || 0); tr.appendChild(tdCost);
        const tdG = document.createElement('td'); tdG.textContent = euro(totalsGross[cat] || 0); tr.appendChild(tdG);
        const tdN = document.createElement('td'); tdN.textContent = euro(totalsNet[cat] || 0); tr.appendChild(tdN);
        revBody.appendChild(tr);
      });

      // revenue share table (% of total per month) based on gross and visible cats
      const shareHead = revenueShareTable.querySelector('thead');
      const shareBody = revenueShareTable.querySelector('tbody');
      shareHead.innerHTML = ''; shareBody.innerHTML = '';

      const trHS = document.createElement('tr');
      const thM = document.createElement('th'); thM.textContent = 'Maand'; trHS.appendChild(thM);
      cats.forEach(cat => { const th=document.createElement('th'); th.textContent = cat; trHS.appendChild(th); });
      shareHead.appendChild(trHS);

      state.monthLabels.forEach(m => {
        const tr = document.createElement('tr');
        const tdMonth = document.createElement('td'); tdMonth.textContent = m; tr.appendChild(tdMonth);

        const monthTotal = cats.reduce((s, cat) => s + (state.revenueGross[m][cat] || 0), 0);
        cats.forEach(cat => {
          const val = state.revenueGross[m][cat] || 0;
          const share = monthTotal > 0 ? (val / monthTotal) * 100 : 0;
          const td = document.createElement('td'); td.textContent = pct(share);
          tr.appendChild(td);
        });

        shareBody.appendChild(tr);
      });
    }

    // -------- Rendering: ABC% --------
    function renderAbcPct() {
      const labels = state.monthLabels;
      const dataA = labels.map(m => (state.abcPct[m] ? state.abcPct[m].pctA : 0));
      const dataB = labels.map(m => (state.abcPct[m] ? state.abcPct[m].pctB : 0));
      const dataC = labels.map(m => (state.abcPct[m] ? state.abcPct[m].pctC : 0));

      const ctx = document.getElementById('abcPctChart');
      if (state.charts.abcPct) state.charts.abcPct.destroy();

      state.charts.abcPct = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'A (%)', data: dataA },
            { label: 'B (%)', data: dataB },
            { label: 'C (%)', data: dataC }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 18, right: 16, top: 10, bottom: 6 } },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${pct(c.parsed.y)}` } }
          },
          scales: {
            x: { stacked: true, title: { display: true, text: 'Maand', font: axisTitleFont() }, ticks: { font: axisTickFont(), padding: 6 } },
            y: {
              stacked: true,
              min: 0,
              max: 100,
              title: { display: true, text: 'Percentage (%)', font: axisTitleFont() },
              ticks: { font: axisTickFont(), padding: 10, callback: (v) => v + '%' }
            }
          }
        }
      });

      // table
      const thead = abcPctTable.querySelector('thead');
      const tbody = abcPctTable.querySelector('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';

      const hr = document.createElement('tr');
      ['Maand', '% A', '% B', '% C', 'Aantal SKU’s (in ABC)'].forEach(h => {
        const th = document.createElement('th'); th.textContent = h; hr.appendChild(th);
      });
      thead.appendChild(hr);

      labels.forEach(m => {
        const v = state.abcPct[m] || {pctA:0,pctB:0,pctC:0,total:0};
        const tr = document.createElement('tr');

        const tdM = document.createElement('td'); tdM.textContent = m; tr.appendChild(tdM);
        const tdA = document.createElement('td'); tdA.textContent = pct(v.pctA); tr.appendChild(tdA);
        const tdB = document.createElement('td'); tdB.textContent = pct(v.pctB); tr.appendChild(tdB);
        const tdC = document.createElement('td'); tdC.textContent = pct(v.pctC); tr.appendChild(tdC);
        const tdT = document.createElement('td'); tdT.textContent = num(v.total, 0); tr.appendChild(tdT);

        tbody.appendChild(tr);
      });
    }

    function renderAll() {
      if (!state.monthLabels.length) return;
      renderInventory();
      renderSales();
      renderRevenue();
      renderAbcPct();
    }

    // -------- Events --------
    excelFileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      setStatus('Bezig met inlezen van het Excel-bestand...');
      destroyCharts();

      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          extractWorkbook(workbook);
          setStatus(`Bestand geladen: ${file.name}`);
          renderAll();
        } catch (err) {
          console.error(err);
          setStatus('Fout bij het inlezen: ' + (err && err.message ? err.message : String(err)));
        }
      };
      reader.readAsArrayBuffer(file);
    });

    toggleTrendlines.addEventListener('change', () => renderInventory());
    revenueModeSelect.addEventListener('change', () => renderRevenue());
  </script>
</body>
</html>
