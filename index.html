<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Voorraad & Verkoop Dashboard + ABC%</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Excel reader -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b1220;
      color: #0f172a;
    }
    header {
      background: linear-gradient(90deg, #0b3954, #1f6feb);
      color: #e5efff;
      padding: 16px 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    header h1 { margin: 0; font-size: 20px; font-weight: 650; }
    header p { margin: 6px 0 0; font-size: 13px; opacity: .92; }

    .container {
      max-width: 1400px;
      margin: 16px auto 40px;
      padding: 18px 18px 30px;
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 14px 30px rgba(15,23,42,.25);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      margin: 12px 0;
    }

    label {
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    input, select {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      font-size: 13px;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: #f1f5f9;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .section {
      margin-top: 22px;
      border-top: 1px solid #e5e7eb;
      padding-top: 14px;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      margin-top: 12px;
      box-shadow: 0 8px 16px rgba(15,23,42,.08);
    }

    .card-header {
      padding: 10px 12px;
      background: linear-gradient(90deg, #0b3954, #1f4f9a);
      color: #e5efff;
      border-bottom: 1px solid #e5e7eb;
      border-radius: 16px 16px 0 0;
      font-size: 13px;
      font-weight: 600;
    }

    .card-body { padding: 12px; }

    .canvas-wrap {
      overflow-x: auto;
    }

    .chart-box {
      min-width: 900px;
      height: 520px;
    }

    canvas { width: 100% !important; height: 100% !important; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 900px;
    }

    thead {
      background: #0b3954;
      color: #e5efff;
    }

    th, td {
      padding: 7px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) { background: #f9fafb; }

    .checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px;
      background: #f8fafc;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
    }

    .cb {
      padding: 6px 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      font-size: 12px;
    }
  </style>
</head>

<body>
<header>
  <h1>Voorraad & Verkoop Dashboard + ABC-analyse</h1>
  <p>Analyse per maand – filters beïnvloeden ook ABC-verdeling</p>
</header>

<div class="container">

  <div class="controls">
    <label>
      Excel upload
      <input type="file" id="excelFileInput" accept=".xlsx,.xls">
    </label>
    <div class="pill">Maanden: <span id="monthsInfo">—</span></div>
    <span id="statusMessage"></span>
  </div>

  <div id="categoryControls" class="checkboxes"></div>

  <div class="section">
    <h2>ABC-analyse – percentage A / B / C producten per maand</h2>

    <div class="card">
      <div class="card-header">ABC verdeling per maand (100% gestapeld)</div>
      <div class="card-body">
        <div class="canvas-wrap">
          <div class="chart-box">
            <canvas id="abcPctChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Tabel: % A / % B / % C per maand</div>
      <div class="card-body">
        <div class="canvas-wrap">
          <table id="abcPctTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===============================
   HULPFUNCTIES
================================ */
function canonicalizeProductType(raw) {
  if (!raw) return null;
  const t = raw.toString().toLowerCase();
  if (t.includes('compressie')) return 'compressiesokken';
  if (t.includes('sneaker')) return 'sneakers';
  if (t.includes('klomp') || t.includes('schoen')) return 'klompen';
  if (t.includes('mok')) return 'mokken';
  if (t.includes('sok')) return 'sokken';
  return raw;
}

function getSellPrice(cat) {
  if (cat === 'sokken') return 11.95;
  if (cat === 'compressiesokken') return 29.99;
  if (cat === 'mokken') return 14.95;
  if (cat === 'klompen') return 79.99;
  if (cat === 'sneakers') return 99.99;
  return 0;
}

function pct(n){ return n.toFixed(1)+'%'; }

/* ===============================
   STATE
================================ */
const state = {
  months: [],
  categories: [],
  selectedCats: new Set(),
  abcPct: {},
  chart: null
};

/* ===============================
   EXCEL INLEZEN
================================ */
document.getElementById('excelFileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, { type: 'array' });
    processWorkbook(workbook);
  };
  reader.readAsArrayBuffer(file);
});

function processWorkbook(workbook) {
  const months = [];

  workbook.SheetNames.forEach(sheetName => {
    const sheet = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: 0 });

    months.push({
      label: sheetName,
      rows: rows.map(r => ({
        sku: r['Product variant SKU'],
        productType: canonicalizeProductType(r['Product type']),
        startingInv: +r['Starting inventory units'] || 0,
        sold: +r['Inventory units sold'] || 0
      }))
    });
  });

  state.months = months;
  document.getElementById('monthsInfo').textContent =
    months.map(m => m.label).join(', ');

  const cats = new Set();
  months.forEach(m => m.rows.forEach(r => cats.add(r.productType)));
  state.categories = [...cats];
  state.selectedCats = new Set(state.categories);

  buildCategoryControls();
  computeAbc();
  renderAbc();
}

/* ===============================
   FILTERS
================================ */
function buildCategoryControls() {
  const el = document.getElementById('categoryControls');
  el.innerHTML = '';

  state.categories.forEach(cat => {
    const lbl = document.createElement('label');
    lbl.className = 'cb';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = true;

    cb.onchange = () => {
      cb.checked ? state.selectedCats.add(cat) : state.selectedCats.delete(cat);
      computeAbc();
      renderAbc();
    };

    lbl.appendChild(cb);
    lbl.appendChild(document.createTextNode(' '+cat));
    el.appendChild(lbl);
  });
}

/* ===============================
   ABC BEREKENING
================================ */
function computeAbc() {
  const abc = {};

  state.months.forEach(month => {
    const skuMap = new Map();

    month.rows.forEach(r => {
      if (!state.selectedCats.has(r.productType)) return;
      if (r.startingInv === 0) return;

      const rev = r.sold * getSellPrice(r.productType);
      if (!skuMap.has(r.sku)) skuMap.set(r.sku, 0);
      skuMap.set(r.sku, skuMap.get(r.sku) + rev);
    });

    const items = [...skuMap.entries()]
      .map(([sku, rev]) => ({ sku, rev }))
      .sort((a,b) => b.rev - a.rev);

    const totalRev = items.reduce((s,i)=>s+i.rev,0);
    let cum = 0, A=0,B=0,C=0;

    items.forEach(i => {
      cum += i.rev;
      const p = cum / totalRev;
      if (p <= 0.8) A++;
      else if (p <= 0.95) B++;
      else C++;
    });

    const total = items.length;
    abc[month.label] = {
      A,B,C,
      pctA: total?A/total*100:0,
      pctB: total?B/total*100:0,
      pctC: total?C/total*100:0
    };
  });

  state.abcPct = abc;
}

/* ===============================
   RENDER
================================ */
function renderAbc() {
  const labels = state.months.map(m=>m.label);
  const dataA = labels.map(l=>state.abcPct[l]?.pctA||0);
  const dataB = labels.map(l=>state.abcPct[l]?.pctB||0);
  const dataC = labels.map(l=>state.abcPct[l]?.pctC||0);

  if (state.chart) state.chart.destroy();

  state.chart = new Chart(
    document.getElementById('abcPctChart'),
    {
      type:'bar',
      data:{
        labels,
        datasets:[
          {label:'A %',data:dataA},
          {label:'B %',data:dataB},
          {label:'C %',data:dataC}
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          x:{stacked:true},
          y:{stacked:true,min:0,max:100}
        }
      }
    }
  );

  const thead = document.querySelector('#abcPctTable thead');
  const tbody = document.querySelector('#abcPctTable tbody');
  thead.innerHTML='';
  tbody.innerHTML='';

  thead.innerHTML = '<tr><th>Maand</th><th>% A</th><th>% B</th><th>% C</th></tr>';

  labels.forEach(l=>{
    const v = state.abcPct[l];
    tbody.innerHTML += `
      <tr>
        <td>${l}</td>
        <td>${pct(v.pctA)}</td>
        <td>${pct(v.pctB)}</td>
        <td>${pct(v.pctC)}</td>
      </tr>`;
  });
}
</script>
</body>
</html>
